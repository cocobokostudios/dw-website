<!DOCTYPE html><html><head><meta charSet="utf-8"/><meta name="viewport" content="width=device-width"/><meta name="next-head-count" content="2"/><link rel="preload" href="https://www.davidwesst.com/_next/static/-9wn_hi6_-Q32OgH9YOcv/pages/_app.js" as="script"/><link rel="preload" href="https://www.davidwesst.com/_next/static/-9wn_hi6_-Q32OgH9YOcv/pages/blog/%5Bid%5D.js" as="script"/><link rel="preload" href="https://www.davidwesst.com/_next/static/runtime/webpack-c212667a5f965e81e004.js" as="script"/><link rel="preload" href="https://www.davidwesst.com/_next/static/chunks/framework.e84fa698c7ee940652bd.js" as="script"/><link rel="preload" href="https://www.davidwesst.com/_next/static/chunks/commons.7c101d7f1672b68d7c1c.js" as="script"/><link rel="preload" href="https://www.davidwesst.com/_next/static/runtime/main-98aa3916935decc0cde3.js" as="script"/></head><body><div id="__next"><h1>How to Use Global NPM Packages on a VSTS Self-Hosted Build Agent</h1><article><div>how-to-use-global-npm-packages-on-a-vsts-self-hosted-build-agent</div><div>Mon Oct 24 2016 03:33:01 GMT-0500 (Central Daylight Time)</div><div><p>I took a couple of weeks off of blogging to focus on a building my presentation for <a href="http://www.prdcdeliver.com/">Deliver</a>. In my spare time, I started tinkering with Visual Studio Team Services, where decided to start by automating the build and release of this blog.</p>
<p>My build script is pretty straight forward. Setup the global dependencies with NPM, setup the local dependencies with NPM, generate the content, and publish the generated assets. This worked in my hosted agent, but not my self-hosted agent.</p>
<p>I found a few solutions, but I'll go through the one I selected for my build agent.</p>
<h3>The Problem</h3>
<p>My build script would run <code>npm install --global hexo-cli</code> and execute as expected. When the next step would try and use the <code>hexo generate</code> command, I would get the following error:</p>
<pre><code>##[error]hexo : The term 'hexo' is not recognized as the name of a cmdlet, function, script file, or operable program. Check 
the spelling of the name, or if a path was included, verify that the path is correct and try again.
</code></pre>
<p>Even though the install command was successful, the build script still couldn't use the tool installed.</p>
<p>Another symptom of this problem is that Team Services can't see global NPM packages as common capabilities, such as Bower, Gulp, and Grunt.</p>
<p><img src="http://i.imgur.com/pkLEzkEl.png" alt="&#x22;Gulp and Grunt as capabilities&#x22;"></p>
<p>I setup my build agent to use the NetworkService user account, but it could be setup for any user. The problem is that the NetworkService account can't see the global packages on the machine after they are installed. The solution is to configure NPM to point to a folder that is visible to the NetworkService account.</p>
<p>Here's how you do it.</p>
<h3>The Solution</h3>
<p>I found <a href="http://stackoverflow.com/questions/38570209/making-global-npm-packages-available-to-all-users-on-windows-2012-server">this solution on StackOverflow</a> which lead me in the right direction, although I didn't follow all of it.</p>
<p>The <a href="https://docs.npmjs.com/cli/prefix"><code>npm prefix -g</code></a> command shows us path to global prefix folder, where the global npm packages are stored. We need to point this to a directory that NetworkService can read and execute. Generally speaking, the prefix folder is usually found in the user's AppData folder.</p>
<p>To change the prefix, run the command <code>npm config set prefix C:\\Path\\To\\Folder\\AppData\\Roaming\\npm</code> which will change the npm prefix folder to be the one specified. Because I've set my build agent NetworkService account, I point it at the NetworkService account AppData npm folder for simplicity.</p>
<p>Then add the folder to the PATH variable for the machine. This will let VSTS see the npm packages as capabilities so that it knows that our build server can execute Grunt, Gulp, and Bower tasks.</p>
<h4>Why Didn't You Reset the Prefix?</h4>
<p>It makes sense to reset the prefix to the previous value after the build has complete, as described in the StackOverflow solution. In my case, I wanted to make sure that if someone were logging into the build server to add another global package, let's say something like Hexo CLI, then it would be installed in the appropriate directory.</p>
<p>I didn't reset the prefix because I wanted to permanently configure the build agent. It's a small build server that I'm using to experiment with continuous integration and deployment. If it's good enough for StackOverflow then it's good enough for me.</p>
<h2>A Few Alternative Solutions</h2>
<p>As an alternative solution you could setup a new directory that isn't the AppData folder, add the new folder to the PATH, and then point the prefix folder at build time. You could also leverage the <code>npm bin</code> setting and setup alias in your package.json file for the global commands you're looking to use (Thanks to <a href="http://www.aaron-powell.com/">Aaron Powell</a> for providing me with that one), which is another good solution that I'll revisit if I use something other than VSTS for builds.</p>
</div></article><footer><a href="/blog">Back to Post Listing</a></footer></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"postData":{"id":"how-to-use-global-npm-packages-on-a-vsts-self-hosted-build-agent","htmlContent":"\u003cp\u003eI took a couple of weeks off of blogging to focus on a building my presentation for \u003ca href=\"http://www.prdcdeliver.com/\"\u003eDeliver\u003c/a\u003e. In my spare time, I started tinkering with Visual Studio Team Services, where decided to start by automating the build and release of this blog.\u003c/p\u003e\n\u003cp\u003eMy build script is pretty straight forward. Setup the global dependencies with NPM, setup the local dependencies with NPM, generate the content, and publish the generated assets. This worked in my hosted agent, but not my self-hosted agent.\u003c/p\u003e\n\u003cp\u003eI found a few solutions, but I'll go through the one I selected for my build agent.\u003c/p\u003e\n\u003ch3\u003eThe Problem\u003c/h3\u003e\n\u003cp\u003eMy build script would run \u003ccode\u003enpm install --global hexo-cli\u003c/code\u003e and execute as expected. When the next step would try and use the \u003ccode\u003ehexo generate\u003c/code\u003e command, I would get the following error:\u003c/p\u003e\n\u003cpre\u003e\u003ccode\u003e##[error]hexo : The term 'hexo' is not recognized as the name of a cmdlet, function, script file, or operable program. Check \nthe spelling of the name, or if a path was included, verify that the path is correct and try again.\n\u003c/code\u003e\u003c/pre\u003e\n\u003cp\u003eEven though the install command was successful, the build script still couldn't use the tool installed.\u003c/p\u003e\n\u003cp\u003eAnother symptom of this problem is that Team Services can't see global NPM packages as common capabilities, such as Bower, Gulp, and Grunt.\u003c/p\u003e\n\u003cp\u003e\u003cimg src=\"http://i.imgur.com/pkLEzkEl.png\" alt=\"\u0026#x22;Gulp and Grunt as capabilities\u0026#x22;\"\u003e\u003c/p\u003e\n\u003cp\u003eI setup my build agent to use the NetworkService user account, but it could be setup for any user. The problem is that the NetworkService account can't see the global packages on the machine after they are installed. The solution is to configure NPM to point to a folder that is visible to the NetworkService account.\u003c/p\u003e\n\u003cp\u003eHere's how you do it.\u003c/p\u003e\n\u003ch3\u003eThe Solution\u003c/h3\u003e\n\u003cp\u003eI found \u003ca href=\"http://stackoverflow.com/questions/38570209/making-global-npm-packages-available-to-all-users-on-windows-2012-server\"\u003ethis solution on StackOverflow\u003c/a\u003e which lead me in the right direction, although I didn't follow all of it.\u003c/p\u003e\n\u003cp\u003eThe \u003ca href=\"https://docs.npmjs.com/cli/prefix\"\u003e\u003ccode\u003enpm prefix -g\u003c/code\u003e\u003c/a\u003e command shows us path to global prefix folder, where the global npm packages are stored. We need to point this to a directory that NetworkService can read and execute. Generally speaking, the prefix folder is usually found in the user's AppData folder.\u003c/p\u003e\n\u003cp\u003eTo change the prefix, run the command \u003ccode\u003enpm config set prefix C:\\\\Path\\\\To\\\\Folder\\\\AppData\\\\Roaming\\\\npm\u003c/code\u003e which will change the npm prefix folder to be the one specified. Because I've set my build agent NetworkService account, I point it at the NetworkService account AppData npm folder for simplicity.\u003c/p\u003e\n\u003cp\u003eThen add the folder to the PATH variable for the machine. This will let VSTS see the npm packages as capabilities so that it knows that our build server can execute Grunt, Gulp, and Bower tasks.\u003c/p\u003e\n\u003ch4\u003eWhy Didn't You Reset the Prefix?\u003c/h4\u003e\n\u003cp\u003eIt makes sense to reset the prefix to the previous value after the build has complete, as described in the StackOverflow solution. In my case, I wanted to make sure that if someone were logging into the build server to add another global package, let's say something like Hexo CLI, then it would be installed in the appropriate directory.\u003c/p\u003e\n\u003cp\u003eI didn't reset the prefix because I wanted to permanently configure the build agent. It's a small build server that I'm using to experiment with continuous integration and deployment. If it's good enough for StackOverflow then it's good enough for me.\u003c/p\u003e\n\u003ch2\u003eA Few Alternative Solutions\u003c/h2\u003e\n\u003cp\u003eAs an alternative solution you could setup a new directory that isn't the AppData folder, add the new folder to the PATH, and then point the prefix folder at build time. You could also leverage the \u003ccode\u003enpm bin\u003c/code\u003e setting and setup alias in your package.json file for the global commands you're looking to use (Thanks to \u003ca href=\"http://www.aaron-powell.com/\"\u003eAaron Powell\u003c/a\u003e for providing me with that one), which is another good solution that I'll revisit if I use something other than VSTS for builds.\u003c/p\u003e\n","layout":"post","title":"How to Use Global NPM Packages on a VSTS Self-Hosted Build Agent","date":"Mon Oct 24 2016 03:33:01 GMT-0500 (Central Daylight Time)","tags":["javascript","visual studio team services","nodejs","npm"],"categories":["development"],"excerpt":"I setup a self-hosted build agent in Visual Studio Team Services. My build installed global NPM packages, but the tasks that used them later on in the script would fail because they were unable to use them. This post describes what I did to get them working.","authorId":"david_wesst","originalurl":"https://blog.davidwesst.com/2016/10/How-to-Use-Global-NPM-Packages-on-a-VSTS-Self-Hosted-Build-Agent/"}},"__N_SSG":true},"page":"/blog/[id]","query":{"id":"how-to-use-global-npm-packages-on-a-vsts-self-hosted-build-agent"},"buildId":"-9wn_hi6_-Q32OgH9YOcv","assetPrefix":"https://www.davidwesst.com","runtimeConfig":{},"nextExport":false,"isFallback":false,"gsp":true}</script><script nomodule="" src="https://www.davidwesst.com/_next/static/runtime/polyfills-10c88b4b028d13fe33de.js"></script><script async="" data-next-page="/_app" src="https://www.davidwesst.com/_next/static/-9wn_hi6_-Q32OgH9YOcv/pages/_app.js"></script><script async="" data-next-page="/blog/[id]" src="https://www.davidwesst.com/_next/static/-9wn_hi6_-Q32OgH9YOcv/pages/blog/%5Bid%5D.js"></script><script src="https://www.davidwesst.com/_next/static/runtime/webpack-c212667a5f965e81e004.js" async=""></script><script src="https://www.davidwesst.com/_next/static/chunks/framework.e84fa698c7ee940652bd.js" async=""></script><script src="https://www.davidwesst.com/_next/static/chunks/commons.7c101d7f1672b68d7c1c.js" async=""></script><script src="https://www.davidwesst.com/_next/static/runtime/main-98aa3916935decc0cde3.js" async=""></script><script src="https://www.davidwesst.com/_next/static/-9wn_hi6_-Q32OgH9YOcv/_buildManifest.js" async=""></script><script src="https://www.davidwesst.com/_next/static/-9wn_hi6_-Q32OgH9YOcv/_ssgManifest.js" async=""></script></body></html>